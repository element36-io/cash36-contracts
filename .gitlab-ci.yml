image: ubuntu:16.04 #luongnguyen/oyente

stages:
 - build
 - test
 - deploy
 - release
 - publish

before_script:
  - apt-get update && apt-get install -y git python g++ make curl
  - curl -sL https://deb.nodesource.com/setup_8.x | bash
  - apt-get install -y nodejs
  - npm install -g yarn

build:
 stage: build
 tags:
   - gitlab-org
 script:
   - yarn
   - yarn build
   - yarn lint
   #- for f in ./contracts/*.sol; do python /oyente/oyente/oyente.py -s $f; done

test:
 stage: test
 tags:
   - gitlab-org
 script:
   - yarn
   - yarn testrpc &
   - yarn test

deploy:
 stage: deploy
 image: docker:latest
 services:
   - docker:dind
 tags:
   - gitlab-org
 before_script:
   - apk add --no-cache nodejs nodejs-npm git python g++ make curl
   - npm install -g yarn
   - yarn
 script:
   - node scripts/waitForEthSyncTest.js
   - echo "{\"privKey\":\"${PRIVATE_KEY}\"}" > keys.json
   - ./node_modules/.bin/truffle migrate --network test
   - ./node_modules/.bin/truffle networks
 artifacts:
   paths:
     - build/
 only:
   - master

release:
  stage: release
  tags:
    - gitlab-org
  script:
    - git config --global user.email "m@element36.io"
    - git config --global user.name "mb-element36"
    - npm install -g semantic-release-gitlab
    - semantic-release-gitlab
  dependencies:
    - deploy
  retry: 1
  allow_failure: false
  only:
    - master

publish:
  stage: publish
  tags:
    - gitlab-org
  script:
    - npm install -g npm-publish-git-tag
    - echo "registry=http://167.99.243.81:4873/" > ~/.npmrc
    - echo "//167.99.243.81:4873/:_authToken='${NPM_TOKEN}'" > ~/.npmrc
    - npm-publish-git-tag --access public
  allow_failure: false
  only:
    - master
